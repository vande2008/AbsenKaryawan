<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">

<!-- ðŸ”§ FIX UTAMA: WAJIB UNTUK HP -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Absen Karyawan</title>

<style>
*{box-sizing:border-box;font-family:system-ui}
body{
    margin:0;
    background:linear-gradient(135deg,#e9eef5,#f8fafc);
}
.screen{display:none;height:100vh;justify-content:center;align-items:center}
.screen.active{display:flex}
.box{
    background:#fff;
    width:360px;
    padding:26px;
    border-radius:16px;
    text-align:center;
    box-shadow:0 15px 35px rgba(0,0,0,.12);
}
h2{margin-top:0}
select,button,textarea{
    width:100%;
    padding:13px;
    margin-top:12px;
    font-size:15px;
    border-radius:10px;
}
button{border:none;cursor:pointer;font-weight:600}
.masuk{background:#22c55e;color:white}
.pulang{background:#ef4444;color:white}
.opsi-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-top:18px;
}
.opsi-grid button{
    background:#f1f5f9;
    border:1px solid #cbd5e1;
}
.popup{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.4);
    justify-content:center;
    align-items:center;
}
.popup.active{display:flex}
.popup-box{
    background:#fff;
    padding:22px;
    border-radius:16px;
    width:300px;
}
.popup-btn{
    display:flex;
    gap:10px;
    margin-top:15px;
}
.popup-btn button{flex:1;padding:10px}
</style>
</head>

<body>

<script>
/* ===== KONFIGURASI ===== */
const OFFICE_LAT = -6.2081517;
const OFFICE_LNG = 106.9996654;
const MAX_DISTANCE = 50;
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZPg8Se2NZ_tb0xNHsj2V1ulxzAFVljubcK3n5t9ujuzVESHfqSQ7xYepmKKPBQmBrLg/execx";

/* ===== VAR ===== */
let lokasiUser = {};
let pilihan = "";

/* ===== UTIL ===== */
function hitungJarak(lat1,lon1,lat2,lon2){
    const R=6371000;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
        Math.sin(dLon/2)**2;
    return R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ===== KIRIM KE SHEET ===== */
function kirimData(status, keterangan="-", izin="-"){
    fetch(SCRIPT_URL,{
        method:"POST",
        body:JSON.stringify({
            nama: nama.value,
            status: status,
            waktu: new Date().toLocaleTimeString("id-ID"),
            gps: lokasiUser.maps || "",
            keterangan: keterangan,
            izin: izin
        })
    });
}

/* ===== GPS CEK ===== */
function cekLokasi(callback){
    if(!nama.value) return alert("Pilih nama karyawan");

    navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude;
        const lng=pos.coords.longitude;
        const jarak=Math.round(hitungJarak(lat,lng,OFFICE_LAT,OFFICE_LNG));

        lokasiUser = {
            lat,lng,jarak,
            maps:`https://maps.google.com/?q=${lat},${lng}`
        };

        if(jarak > MAX_DISTANCE){
            popupIzin.classList.add("active");
            return;
        }

        callback();
    },()=>alert("GPS tidak aktif"),{enableHighAccuracy:true});
}

/* ===== ABSEN ===== */
function absenMasuk(){
    kirimData("Masuk");
    alert("âœ… Absen Masuk Berhasil");
}

function kePulang(){
    screenAbsen.classList.remove("active");
    screenPulang.classList.add("active");
}

function pilihOpsi(o){
    pilihan=o;
    popupText.innerText="Konfirmasi aktivitas:\n"+o;
    popup.classList.add("active");
}

function konfirmasi(){
    kirimData("Pulang", pilihan);
    alert("âœ… Absen Pulang Berhasil");
    popup.classList.remove("active");
    screenPulang.classList.remove("active");
    screenAbsen.classList.add("active");
}

function batal(){
    popup.classList.remove("active");
}

/* ===== SISTEM IZIN ADMIN ===== */
function kirimIzin(){
    if(!alasan.value) return alert("Alasan wajib diisi");

    kirimData("IZIN", alasan.value, "Pending");
    alert("ðŸ“¨ Izin dikirim ke admin\nMenunggu persetujuan");
    popupIzin.classList.remove("active");
    alasan.value = "";
}

function batalIzin(){
    popupIzin.classList.remove("active");
}
</script>

<!-- SCREEN ABSEN -->
<div class="screen active" id="screenAbsen">
    <div class="box">
        <h2>Absen Karyawan</h2>
        <select id="nama">
            <option value="">Pilih Nama</option>
            <option>Udin</option>
            <option>Rosidik</option>
            <option>Gumgum</option>
            <option>Yunus</option>
            <option>Wasimin</option>
            <option>Angga</option>
        </select>
        <button class="masuk" onclick="cekLokasi(absenMasuk)">Absen Masuk</button>
        <button class="pulang" onclick="cekLokasi(kePulang)">Absen Pulang</button>
    </div>
</div>

<!-- SCREEN PULANG -->
<div class="screen" id="screenPulang">
    <div class="box">
        <h2>Aktivitas Kerja</h2>
        <div class="opsi-grid">
            <button onclick="pilihOpsi('Standby')">Standby</button>
            <button onclick="pilihOpsi('Storing')">Storing</button>
            <button onclick="pilihOpsi('Operator')">Operator</button>
            <button onclick="pilihOpsi('Motoris')">Motoris</button>
            <button onclick="pilihOpsi('Ngawal Mobil')">Ngawal Mobil</button>
            <button onclick="pilihOpsi('Mengirim Barang')">Mengirim Barang</button>
        </div>
    </div>
</div>

<!-- POPUP KONFIRMASI PULANG -->
<div class="popup" id="popup">
    <div class="popup-box">
        <p id="popupText"></p>
        <div class="popup-btn">
            <button onclick="konfirmasi()">âœ”</button>
            <button onclick="batal()">âœ–</button>
        </div>
    </div>
</div>

<!-- POPUP IZIN ADMIN -->
<div class="popup" id="popupIzin">
  <div class="popup-box">
    <h3>Izin ke Admin</h3>
    <textarea id="alasan" placeholder="Tulis alasan kenapa absen di luar lokasi..."
      style="width:100%;height:80px;padding:10px;border-radius:10px;margin-top:10px">
    </textarea>
    <div class="popup-btn">
      <button onclick="kirimIzin()">Kirim</button>
      <button onclick="batalIzin()">Batal</button>
    </div>
  </div>
</div>

</body>
</html>
